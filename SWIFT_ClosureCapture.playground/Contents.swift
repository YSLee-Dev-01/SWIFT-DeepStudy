import Foundation
import PlaygroundSupport

/// Closure Capture
///
/// í´ë¡œì €ëŠ” í´ë¡œì € ì™¸ë¶€ì— ìˆëŠ” ê°’ì„ ì‚¬ìš©í•  ë•Œ ìº¡ì²˜í•´ì„œ ì‚¬ìš©í•¨ (ê°’, ì°¸ì¡°íƒ€ì… ì „ë¶€)
/// - ì´ë•Œ í´ë¡œì € ìƒì„± (ì„ ì–¸) ì‹œì ì´ ì•„ë‹Œ, ì‹¤í–‰ ì‹œì ì˜ ê°’ì´ ì‚¬ìš©ë¨
/// - ìº¡ì²˜ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•œ ê²½ìš° ì„ ì–¸ ì‹œì ì˜ ê°’ì´ ì‚¬ìš©ë¨

var count = 1
let closure: (() -> ()) = {
    print("1ï¸âƒ£ í´ë¡œì € ê°’: \(count)")
}

count = 100
closure()

let closure2: (() -> ()) = { [count] in
    print("2ï¸âƒ£ í´ë¡œì € ê°’: \(count)")
}

count = 1000
closure2()

/// í´ë¡œì €ëŠ” ì°¸ì¡°íƒ€ì…ì´ê¸° ë•Œë¬¸ì— heap ë©”ëª¨ë¦¬ì— ì €ì¥ë¨
/// - í´ë¡œì € ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë³€ìˆ˜ëŠ” ìº¡ì²˜ë¦¬ìŠ¤íŠ¸ ì‚¬ìš© ìœ ë¬´, ê°’/ì°¸ì¡° íƒ€ì… ìœ ë¬´ì— ë”°ë¼ ë‹¤ë¦„
///
/// ìº¡ì²˜ë¦¬ìŠ¤íŠ¸ X
/// ê°’íƒ€ì…
/// - ê¸°ì¡´ stackì— ì €ì¥ë˜ì–´ ìˆë˜ ë³€ìˆ˜ë¥¼ boxë¡œ ê°ì‹¸ì„œ heapì— í• ë‹¹í•¨
/// - ê¸°ì¡´ ë³€ìˆ˜ëŠ” heapì— boxë¥¼ ì°¸ì¡°í•˜ë„ë¡ ë³€ê²½, í´ë¡œì €ë„ heapì— boxë¥¼ ì°¸ì¡°
/// -> ê¸°ì¡´ stackì— ì €ì¥ë˜ì–´ ìˆë˜ ë³€ìˆ˜ëŠ” í•¨ìˆ˜ ì¢…ë£Œ ì‹œ í•´ì œë¨
///
/// ì°¸ì¡°íƒ€ì…
/// - RCë¥¼ ì¦ê°€ì‹œí‚¤ë©° ì°¸ì¡°í•¨
///
/// ìº¡ì²˜ë¦¬ìŠ¤íŠ¸ O
/// ê°’íƒ€ì…
/// - ê·¸ ì‹œì ì˜ ê°’ì„ ë³µì‚¬í•˜ì—¬ í´ë¡œì €ì˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•¨ (heap)
/// - ê¸°ì¡´ ê°’ì€ ì°¸ì¡°í•˜ì§€ ì•ŠìŒ
///
/// ì°¸ì¡°íƒ€ì…
/// - ì—¬ì „íˆ ì°¸ì¡°í•¨ (weak, unownedë¡œ ì„ ì–¸í•œ ê²½ìš° RC ì¦ê°€ X)

struct Person {
    var name: String
    var old: Int
}

class Pet {
    var name: String
    var old: Int
    
    init(name: String, old: Int) {
        self.name = name
        self.old = old
    }
    
    deinit {
        print("âœ‹ \(name) deinit")
    }
}

func closure3Create() -> (() -> ()) {
    var ìœ ì¬ì„ = Person(name: "ìœ ì¬ì„", old: 20) // stack -> heap
    var ë½€ì‚ = Pet(name: "ë½€ì‚", old: 5) // stack -> heap
    
    print("3ï¸âƒ£ í•¨ìˆ˜ ì‹œì‘")
    print(ìœ ì¬ì„.name, ìœ ì¬ì„.old)
    print(ë½€ì‚.name, ë½€ì‚.old)

    let closure = { [pet = ë½€ì‚, personOld = ìœ ì¬ì„.old] in
        defer {
            print("ğŸ”š í´ë¡œì € ì¢…ë£Œ")
        }
        
        //personOld = 50 // ë³µì‚¬ëœ ìƒìˆ˜ ê°’ì€ ìˆ˜ì • ë¶ˆê°€
        ìœ ì¬ì„.old = 50 // ìº¡ì²˜ë¦¬ìŠ¤íŠ¸ì— ì—†ê¸° ë•Œë¬¸ì— ìº¡ì²˜
        pet.old = 50 // ìº¡ì²˜ë¦¬ìŠ¤íŠ¸ì— ìˆì§€ë§Œ ì°¸ì¡°íƒ€ì…ì´ê¸° ë•Œë¬¸ì— ìº¡ì²˜
        
        print("ğŸ¬ í´ë¡œì € ì‹¤í–‰")
        print(ìœ ì¬ì„.name, ìœ ì¬ì„.old)
        print(pet.name, pet.old)
    }
    
    print("ğŸ”š í•¨ìˆ˜ ì¢…ë£Œ")
    return closure
}

var closure3: (() -> ())? = closure3Create()
closure3?() // create í•¨ìˆ˜ ì¢…ë£Œ ì´í›„ì—ë„ ìœ ì¬ì„, ë½€ì‚ ë³€ìˆ˜ì— ì ‘ê·¼ ê°€ëŠ¥

closure3 = nil // rcê°€ 0ì´ ë˜ì–´ ë½€ì‚ deinit
